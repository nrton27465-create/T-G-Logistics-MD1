<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>ğŸšš Driver App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue-900: #03174a;
      --blue-800: #052d8a;
      --blue-700: #0a3fb5;
      --blue-600: #1a5cd8;
      --blue-500: #2e7cf6;
      --blue-400: #5b9eff;
      --blue-300: #93c0ff;
      --blue-200: #c8dfff;
      --blue-100: #e8f1ff;
      --white:    #ffffff;
      --surface:  #f0f5ff;
      --text-primary: #03174a;
      --text-muted:   #4a6fa8;
      --radius-sm: 12px;
      --radius-md: 20px;
      --radius-lg: 28px;
      --shadow-sm: 0 2px 8px rgba(3,23,74,.10);
      --shadow-md: 0 6px 24px rgba(3,23,74,.14);
      --shadow-lg: 0 12px 48px rgba(3,23,74,.18);
      --fs-xs:  14px;
--fs-sm:  16px;
--fs-md:  18px;
--fs-lg:  20px;
--fs-xl:  23px;
--fs-2xl: 27px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 16px; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Sarabun', sans-serif;
      background: var(--surface);
      color: var(--text-primary);
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    .app-header {
      background: linear-gradient(135deg, var(--blue-900) 0%, var(--blue-700) 100%);
      padding: env(safe-area-inset-top, 0) 0 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 20px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-icon {
      width: 56px;
      height: 56px;
      background: rgba(255,255,255,.15);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      backdrop-filter: blur(8px);
    }

    .header-title {
      font-size: var(--fs-lg);
      font-weight: 800;
      color: var(--white);
      line-height: 1.1;
      letter-spacing: -0.5px;
    }

    .header-sub {
      font-size: var(--fs-xs);
      color: var(--blue-300);
      font-weight: 400;
      margin-top: 2px;
    }

    .btn-refresh {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,.12);
      border: 1.5px solid rgba(255,255,255,.25);
      color: white;
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .2s;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .btn-refresh:active { transform: scale(.9); background: rgba(255,255,255,.22); }

    /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
    .main {
      padding: 24px 20px;
      max-width: 640px;
      margin: 0 auto;
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 32px);
    }

    /* â”€â”€â”€ ALERT â”€â”€â”€ */
    .alert {
      border-radius: var(--radius-md);
      padding: 20px 22px;
      font-size: var(--fs-sm);
      font-weight: 600;
      margin-bottom: 24px;
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }
    .alert-icon { font-size: var(--fs-md); flex-shrink: 0; margin-top: 2px; }
    .alert-warning { background: #fff7e0; color: #7a4f00; border: 2px solid #f5c842; }
    .alert-info    { background: var(--blue-100); color: var(--blue-800); border: 2px solid var(--blue-300); }
    .alert-danger  { background: #ffe8e8; color: #8b0000; border: 2px solid #ff8080; }
    .alert-success { background: #e6faf0; color: #0a5c2e; border: 2px solid #4fd494; }

    /* â”€â”€â”€ SECTION LABEL â”€â”€â”€ */
    .section-label {
      font-size: var(--fs-xs);
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
    }

    /* â”€â”€â”€ CARD â”€â”€â”€ */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .card-body { padding: 24px; }
    .card-body + .card-body { border-top: 1.5px solid var(--blue-100); }

    /* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€ */
    .form-label {
      display: block;
      font-size: var(--fs-xs);
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 8px;
      letter-spacing: .3px;
    }

    .form-control, .form-select {
      width: 100%;
      font-family: 'Sarabun', sans-serif;
      font-size: var(--fs-md);
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface);
      border: 2px solid var(--blue-200);
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
      -webkit-appearance: none;
      appearance: none;
      line-height: 1.3;
    }
    .form-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231a5cd8' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 18px center;
      background-size: 24px;
      padding-right: 52px;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 4px rgba(46,124,246,.14);
      background: white;
    }

    /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      font-family: 'Sarabun', sans-serif;
      font-size: var(--fs-md);
      font-weight: 700;
      border: none;
      border-radius: var(--radius-sm);
      padding: 18px 24px;
      cursor: pointer;
      transition: all .18s;
      letter-spacing: .2px;
      min-height: 68px;
      line-height: 1.2;
    }
    .btn:active { transform: scale(.97); }

    .btn-primary {
      background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-500) 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(46,124,246,.35);
    }
    .btn-primary:active { box-shadow: 0 2px 8px rgba(46,124,246,.20); }

    .btn-progress {
      background: linear-gradient(135deg, #1a8cf0 0%, #0ea5e9 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(14,165,233,.32);
    }
    .btn-progress:active { box-shadow: 0 2px 8px rgba(14,165,233,.16); }

    .btn-success {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(16,185,129,.32);
    }
    .btn-success:active { box-shadow: 0 2px 8px rgba(16,185,129,.16); }

    .btn-outline {
      background: transparent;
      color: var(--blue-600);
      border: 2.5px solid var(--blue-300);
    }
    .btn-outline:active { background: var(--blue-100); }

    /* â”€â”€â”€ STATUS BADGE â”€â”€â”€ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 100px;
      font-size: var(--fs-xs);
      font-weight: 700;
      letter-spacing: .5px;
    }
    .status-badge::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .badge-assigned {
      background: #e8f0ff;
      color: var(--blue-700);
    }
    .badge-assigned::before { background: var(--blue-500); }
    .badge-progress {
      background: #fff3cd;
      color: #7a4f00;
    }
    .badge-progress::before { background: #f59e0b; animation: pulse 1.5s ease-in-out infinite; }
    .badge-delivered {
      background: #d1fae5;
      color: #065f46;
    }
    .badge-delivered::before { background: #10b981; }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: .5; transform: scale(.75); }
    }

    /* â”€â”€â”€ TRIP CARD â”€â”€â”€ */
    .trip-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: 20px;
      border: 1.5px solid var(--blue-100);
      transition: box-shadow .2s;
    }

    .trip-header {
      padding: 22px 24px 18px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1.5px solid var(--blue-100);
    }

    .trip-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: var(--fs-sm);
      font-weight: 700;
      color: var(--blue-700);
      letter-spacing: -.3px;
      line-height: 1.2;
    }

    .trip-meta {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .trip-meta-item {
      font-size: var(--fs-xs);
      color: var(--text-muted);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .trip-meta-icon { font-size: 20px; }

    .trip-body {
      padding: 20px 24px;
    }

    /* â”€â”€â”€ ODO ROW â”€â”€â”€ */
    .odo-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 16px;
    }

    .odo-field { display: flex; flex-direction: column; }

    /* â”€â”€â”€ NOTE FIELD â”€â”€â”€ */
    .note-field { margin-bottom: 20px; }

    /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
    .divider {
      border: none;
      border-top: 1.5px solid var(--blue-100);
      margin: 0 -24px 20px;
    }

    /* â”€â”€â”€ LOADING â”€â”€â”€ */
    .loading-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 0;
      gap: 20px;
    }
    .spinner {
      width: 56px;
      height: 56px;
      border: 5px solid var(--blue-200);
      border-top-color: var(--blue-500);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-size: var(--fs-sm);
      color: var(--text-muted);
      font-weight: 600;
    }

    /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 64px 24px;
    }
    .empty-icon { font-size: 72px; margin-bottom: 20px; }
    .empty-title {
      font-size: var(--fs-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    .empty-desc {
      font-size: var(--fs-sm);
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* â”€â”€â”€ COUNT BADGE â”€â”€â”€ */
    .trip-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--blue-600);
      color: white;
      border-radius: 100px;
      font-size: var(--fs-xs);
      font-weight: 800;
      padding: 4px 14px;
      margin-left: 10px;
    }

    /* â”€â”€â”€ TOAST NOTIFICATION â”€â”€â”€ */
    .toast-container {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0) + 24px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      pointer-events: none;
      width: calc(100vw - 48px);
      max-width: 560px;
    }
    .toast {
      background: var(--blue-900);
      color: white;
      border-radius: var(--radius-md);
      padding: 18px 24px;
      font-size: var(--fs-sm);
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity .3s, transform .3s;
      width: 100%;
      text-align: center;
      line-height: 1.4;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.toast-success { background: linear-gradient(135deg, #047857, #059669); }
    .toast.toast-error   { background: linear-gradient(135deg, #991b1b, #dc2626); }

    /* â”€â”€â”€ SECTION HEADER â”€â”€â”€ */
    .section-head {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
    }
    .section-head-title {
      font-size: var(--fs-md);
      font-weight: 800;
      color: var(--text-primary);
    }

    /* safe area bottom padding */
    .safe-bottom { height: env(safe-area-inset-bottom, 0); }
  </style>
</head>
<body>

<!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
<header class="app-header">
  <div class="header-inner">
    <div class="header-brand">
      <div class="header-icon">ğŸšš</div>
      <div>
        <div class="header-title">Driver App</div>
        <div class="header-sub">à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸²à¸™à¸‚à¸™à¸ªà¹ˆà¸‡</div>
      </div>
    </div>
    <button class="btn-refresh" onclick="refreshApp()" title="à¸£à¸µà¹€à¸Ÿà¸£à¸Š">â†»</button>
  </div>
</header>

<!-- â”€â”€â”€ MAIN â”€â”€â”€ -->
<main class="main">

  <!-- Config warning (shown only when SCRIPT_URL is not set) -->
  <div id="configAlert" class="alert alert-warning" style="display:none">
    <div class="alert-icon">âš ï¸</div>
    <div>
      <div style="font-weight:800;margin-bottom:4px;">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²</div>
      <div>à¸à¸£à¸¸à¸“à¸²à¹à¸à¹‰à¸„à¹ˆà¸² <code>SCRIPT_URL</code> à¹ƒà¸™à¹‚à¸„à¹‰à¸”à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸¥à¸´à¸‡à¸à¹Œ /exec à¸ˆà¸²à¸ Apps Script</div>
    </div>
  </div>

  <!-- Driver selector card -->
  <div class="card">
    <div class="card-body">
      <label class="form-label">ğŸ‘¤ à¹€à¸¥à¸·à¸­à¸à¸Šà¸·à¹ˆà¸­à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸±à¸š</label>
      <select id="driverId" class="form-select">
        <option value="">â€” à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­... â€”</option>
      </select>
    </div>
    <div class="card-body">
      <button class="btn btn-primary" onclick="loadMyTrips()">
        ğŸ“‹ à¹‚à¸«à¸¥à¸”à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™
      </button>
    </div>
  </div>

  <!-- Trip list output -->
  <div id="listBox"></div>

</main>

<!-- â”€â”€â”€ TOAST CONTAINER â”€â”€â”€ -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ‘‰  à¹ƒà¸ªà¹ˆ URL /exec à¸‚à¸­à¸‡ Apps Script à¸•à¸£à¸‡à¸™à¸µà¹‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwm3m84gxgShc5zkAzixv1eBLzX5K1r5o3SFgdTa-m_xZYthskiBDb8QBy5p7gbSJDOhg/exec";

/* â”€â”€ DDL Cache â”€â”€ */
let DDL = { drivers: [] };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JSONP helper
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);
    Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));

    const script = document.createElement("script");
    script.src = url.toString();
    script.onerror = () => { cleanup(); reject(new Error("à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š SCRIPT_URL")); };

    window[cb] = (data) => { cleanup(); resolve(data); };
    function cleanup() { delete window[cb]; script.remove(); }

    document.body.appendChild(script);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Escape HTML
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function h(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => (
    { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]
  ));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast notifications
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg, type = "default") {
  const el = document.createElement("div");
  el.className = "toast" + (type === "success" ? " toast-success" : type === "error" ? " toast-error" : "");
  el.textContent = msg;
  const container = document.getElementById("toastContainer");
  container.appendChild(el);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => el.classList.add("show"));
  });
  setTimeout(() => {
    el.classList.remove("show");
    setTimeout(() => el.remove(), 400);
  }, 3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Set loading state in listBox
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setLoading(msg = "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...") {
  document.getElementById("listBox").innerHTML = `
    <div class="loading-wrap">
      <div class="spinner"></div>
      <div class="loading-text">${h(msg)}</div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Bootstrap (load driver list)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function bootstrap() {
  const isPlaceholder = !SCRIPT_URL || SCRIPT_URL.includes("PASTE_");
  if (isPlaceholder) {
    document.getElementById("configAlert").style.display = "flex";
    document.getElementById("driverId").innerHTML = `<option value="">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² SCRIPT_URL</option>`;
    return;
  }

  const sel = document.getElementById("driverId");
  sel.innerHTML = `<option value="">â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­...</option>`;
  sel.disabled = true;

  try {
    const data = await jsonp("bootstrap");
    if (!data.ok) throw new Error(data.error || "bootstrap error");

    DDL = data.ddl || { drivers: [] };
    sel.innerHTML = `<option value="">â€” à¹€à¸¥à¸·à¸­à¸à¸Šà¸·à¹ˆà¸­à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸±à¸š â€”</option>` +
      DDL.drivers.map(d =>
        `<option value="${h(d.id)}">${h(d.name)}</option>`
      ).join("");
    sel.disabled = false;

  } catch (err) {
    sel.innerHTML = `<option value="">âš ï¸ à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰</option>`;
    sel.disabled = false;
    showToast("à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + err.message, "error");
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Refresh entire app
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshApp() {
  document.getElementById("listBox").innerHTML = "";
  bootstrap();
  showToast("à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¹à¸¥à¹‰à¸§ âœ“");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Load driver's trips
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadMyTrips() {
  const driverId = document.getElementById("driverId").value;
  if (!driverId) { showToast("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸Šà¸·à¹ˆà¸­à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸±à¸šà¸à¹ˆà¸­à¸™", "error"); return; }

  setLoading("à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‡à¸²à¸™...");

  try {
    const res = await jsonp("driverListMyTrips", { driverId });
    renderTrips(res);
  } catch (err) {
    document.getElementById("listBox").innerHTML = `
      <div class="alert alert-danger">
        <div class="alert-icon">âŒ</div>
        <div>à¹‚à¸«à¸¥à¸”à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${h(err.message)}</div>
      </div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Render trips
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTrips(res) {
  const box = document.getElementById("listBox");

  if (!res.ok) {
    box.innerHTML = `
      <div class="alert alert-danger">
        <div class="alert-icon">âŒ</div>
        <div>${h(res.error || "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”")}</div>
      </div>`;
    return;
  }

  if (!res.trips || !res.trips.length) {
    box.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <div class="empty-title">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‡à¸²à¸™</div>
        <div class="empty-desc">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‡à¸²à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢<br>à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸­à¸­à¸Ÿà¸Ÿà¸´à¸¨</div>
      </div>`;
    return;
  }

  const count = res.trips.length;
  let html = `
    <div class="section-head">
      <div class="section-head-title">à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™</div>
      <span class="trip-count">${count}</span>
    </div>`;

  res.trips.forEach(t => {
    const st = (t.status || "").toUpperCase();
    const badgeClass =
      st === "ASSIGNED"    ? "badge-assigned" :
      st === "IN_PROGRESS" ? "badge-progress"  :
      "badge-delivered";
    const badgeLabel =
      st === "ASSIGNED"    ? "à¸£à¸­à¸£à¸±à¸šà¸‡à¸²à¸™"     :
      st === "IN_PROGRESS" ? "à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¹ˆà¸‡à¸‡à¸²à¸™" :
      "à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§";

    const dateStr = t.tripDate ? String(t.tripDate).slice(0, 10) : "â€”";

    html += `
      <div class="trip-card" id="card_${h(t.tripId)}">
        <div class="trip-header">
          <div>
            <div class="trip-id">${h(t.tripId)}</div>
            <div class="trip-meta">
              <div class="trip-meta-item"><span class="trip-meta-icon">ğŸ“¦</span> Order: ${h(t.orderId)}</div>
              <div class="trip-meta-item"><span class="trip-meta-icon">ğŸ“…</span> ${h(dateStr)}</div>
              <div class="trip-meta-item"><span class="trip-meta-icon">ğŸš›</span> ${h(t.truckName || t.truckId)}</div>
            </div>
          </div>
          <span class="status-badge ${badgeClass}">${badgeLabel}</span>
        </div>

        <div class="trip-body">
          <div class="odo-row">
            <div class="odo-field">
              <label class="form-label">ğŸ“ à¹€à¸¥à¸‚à¹„à¸¡à¸¥à¹Œà¹€à¸£à¸´à¹ˆà¸¡</label>
              <input id="startOdo_${h(t.tripId)}" class="form-control"
                     type="number" inputmode="numeric" pattern="[0-9]*"
                     step="1" placeholder="à¸à¸¡."
                     value="${h(t.startOdo || "")}">
            </div>
            <div class="odo-field">
              <label class="form-label">ğŸ à¹€à¸¥à¸‚à¹„à¸¡à¸¥à¹Œà¸ˆà¸š</label>
              <input id="endOdo_${h(t.tripId)}" class="form-control"
                     type="number" inputmode="numeric" pattern="[0-9]*"
                     step="1" placeholder="à¸à¸¡."
                     value="${h(t.endOdo || "")}">
            </div>
          </div>

          <div class="note-field">
            <label class="form-label">ğŸ“ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
            <input id="note_${h(t.tripId)}" class="form-control"
                   type="text" placeholder="à¹€à¸Šà¹ˆà¸™ à¸£à¸–à¸•à¸´à¸” / à¸ˆà¸¸à¸”à¸¥à¸‡à¸‚à¸­à¸‡..."
                   value="">
          </div>

          <hr class="divider">

          ${st === "ASSIGNED" ? `
            <button class="btn btn-progress" onclick="setInProgress('${h(t.tripId)}')">
              â–¶ï¸ à¸£à¸±à¸šà¸‡à¸²à¸™ / à¸­à¸­à¸à¸§à¸´à¹ˆà¸‡
            </button>` : ""}
          ${st === "IN_PROGRESS" ? `
            <button class="btn btn-success" onclick="setDelivered('${h(t.tripId)}')">
              âœ… à¸–à¸¶à¸‡à¸—à¸µà¹ˆà¸«à¸¡à¸²à¸¢ / à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§
            </button>` : ""}
          ${st === "DELIVERED" ? `
            <div class="alert alert-success" style="margin-bottom:0;border-radius:12px;">
              <div class="alert-icon">âœ…</div>
              <div style="font-weight:700;">à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§</div>
            </div>` : ""}
        </div>
      </div>`;
  });

  box.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Set trip â†’ IN_PROGRESS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function setInProgress(tripId) {
  const startOdo = document.getElementById("startOdo_" + tripId)?.value || "";
  const note     = document.getElementById("note_"     + tripId)?.value || "";

  setCardBusy(tripId, true);
  try {
    const res = await jsonp("driverUpdateStatus", {
      tripId, status: "IN_PROGRESS", startOdo, note
    });
    if (!res.ok) throw new Error(res.error || "à¸­à¸±à¸›à¹€à¸”à¸•à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
    showToast("à¸£à¸±à¸šà¸‡à¸²à¸™à¹à¸¥à¹‰à¸§ ğŸš€ à¸à¸³à¸¥à¸±à¸‡à¸­à¸­à¸à¸§à¸´à¹ˆà¸‡", "success");
    await loadMyTrips();
  } catch (err) {
    showToast("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message, "error");
    setCardBusy(tripId, false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Set trip â†’ DELIVERED
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function setDelivered(tripId) {
  const endOdo = document.getElementById("endOdo_" + tripId)?.value || "";
  const note   = document.getElementById("note_"   + tripId)?.value || "";

  setCardBusy(tripId, true);
  try {
    const res = await jsonp("driverUpdateStatus", {
      tripId, status: "DELIVERED", endOdo, note
    });
    if (!res.ok) throw new Error(res.error || "à¸­à¸±à¸›à¹€à¸”à¸•à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
    showToast("à¸ªà¹ˆà¸‡à¸‡à¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ âœ…", "success");
    await loadMyTrips();
  } catch (err) {
    showToast("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message, "error");
    setCardBusy(tripId, false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI helpers
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setCardBusy(tripId, busy) {
  const card = document.getElementById("card_" + tripId);
  if (!card) return;
  const btn = card.querySelector("button");
  if (!btn) return;
  if (busy) {
    btn.disabled = true;
    btn.textContent = "â³ à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹€à¸”à¸•...";
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Init
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener("load", bootstrap);
</script>
</body>
</html>
