<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transport - Driver</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b1020; color:#e5edff; }
    .card { background:#121936; border:0; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .badge { font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .btn-primary { background:#5b7cff; border:0; }
    .small-muted { color:#9fb0ff; }
  </style>
</head>
<body>
<div class="container py-3">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h4 class="mb-0">üöö Driver App</h4>
      <div class="small-muted">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Ä¢ ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</div>
    </div>
    <button class="btn btn-outline-light btn-sm" onclick="bootstrap()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div class="alert alert-warning">
    <div class="fw-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    <div class="small">‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ <span class="mono">https://script.google.com/macros/s/AKfycbwUGLjts4qji5id3salfr7n1pdiIRZd3Bud_XHfdY1D4PKFJbRMfQT5hydykoAEEArI/exec</span> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏à‡∏≤‡∏Å Apps Script</div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-12">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö</label>
        <select id="driverId" class="form-select"></select>
      </div>
      <div class="col-12">
        <button class="btn btn-primary w-100" onclick="loadMyTrips()">‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <div id="listBox"></div>

</div>

<script>
/** üëâ ‡πÉ‡∏™‡πà URL /exec ‡∏Ç‡∏≠‡∏á Apps Script */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwUGLjts4qji5id3salfr7n1pdiIRZd3Bud_XHfdY1D4PKFJbRMfQT5hydykoAEEArI/exec";

/** JSONP helper */
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);
    Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
    const script = document.createElement("script");
    script.src = url.toString();
    script.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };
    window[cb] = (data) => { cleanup(); resolve(data); };
    function cleanup(){ delete window[cb]; script.remove(); }
    document.body.appendChild(script);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

let DDL = { drivers:[] };

async function bootstrap() {
  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_")) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SCRIPT_URL ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const data = await jsonp("bootstrap");
  if (!data.ok) { alert(data.error || "bootstrap error"); return; }
  DDL = data.ddl || { drivers:[] };
  const sel = document.getElementById("driverId");
  sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>` + DDL.drivers.map(d =>
    `<option value="${escapeHtml(d.id)}">${escapeHtml(d.name)} (${escapeHtml(d.id)})</option>`
  ).join("");
}

async function loadMyTrips() {
  const driverId = document.getElementById("driverId").value;
  if (!driverId) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö"); return; }

  const res = await jsonp("driverListMyTrips", { driverId });
  const box = document.getElementById("listBox");
  box.innerHTML = "";

  if (!res.ok) {
    box.innerHTML = `<div class="alert alert-danger">${escapeHtml(res.error || "error")}</div>`;
    return;
  }

  if (!res.trips.length) {
    box.innerHTML = `<div class="alert alert-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</div>`;
    return;
  }

  res.trips.forEach(t => {
    const st = (t.status || "").toUpperCase();
    const badge = st === "ASSIGNED" ? "bg-secondary" : (st === "IN_PROGRESS" ? "bg-warning text-dark" : "bg-success");
    box.innerHTML += `
      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="fw-bold mono">${escapeHtml(t.tripId)}</div>
            <div class="small-muted">Order: ${escapeHtml(t.orderId)} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml(t.tripDate||"")}</div>
            <div class="small-muted">‡∏£‡∏ñ: ${escapeHtml(t.truckName||t.truckId)}</div>
          </div>
          <span class="badge ${badge}">${escapeHtml(st)}</span>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
            <input id="startOdo_${t.tripId}" class="form-control" type="number" step="1" value="${t.startOdo || ""}">
          </div>
          <div class="col-6">
            <label class="form-label">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö</label>
            <input id="endOdo_${t.tripId}" class="form-control" type="number" step="1" value="${t.endOdo || ""}">
          </div>
          <div class="col-12">
            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <input id="note_${t.tripId}" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î / ‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏Ç‡∏≠‡∏á..." value="">
          </div>
        </div>

        <div class="d-grid gap-2 mt-3">
          ${st === "ASSIGNED" ? `<button class="btn btn-primary" onclick="setInProgress('${t.tripId}')">‚ñ∂Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô / ‡∏≠‡∏≠‡∏Å‡∏ß‡∏¥‡πà‡∏á</button>` : ``}
          ${st === "IN_PROGRESS" ? `<button class="btn btn-success" onclick="setDelivered('${t.tripId}')">‚úÖ ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢ / ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>` : ``}
        </div>
      </div>
    `;
  });
}

async function setInProgress(tripId) {
  const startOdo = document.getElementById("startOdo_" + tripId).value;
  const note = document.getElementById("note_" + tripId).value;
  const res = await jsonp("driverUpdateStatus", {
    tripId, status: "IN_PROGRESS", startOdo, note
  });
  if (!res.ok) { alert(res.error || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
  alert("‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
  loadMyTrips();
}

async function setDelivered(tripId) {
  const endOdo = document.getElementById("endOdo_" + tripId).value;
  const note = document.getElementById("note_" + tripId).value;
  const res = await jsonp("driverUpdateStatus", {
    tripId, status: "DELIVERED", endOdo, note
  });
  if (!res.ok) { alert(res.error || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
  alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  loadMyTrips();
}

window.addEventListener("load", bootstrap);
</script>
</body>
</html>
